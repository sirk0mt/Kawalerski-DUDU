<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üèÅ Turniej Wy≈õcigowy - Wiecz√≥r Kawalerski</title>
    <meta name="description" content="Prosty manager turnieju wy≈õcigowego (kwalifikacje ‚Üí grupy ‚Üí faza pucharowa) gotowy na GitHub Pages." />
    <style>
        /* (styles unchanged except small cleanups) */
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#ff3333;--secondary:#333;--success:#4CAF50;--warning:#ff9800;--danger:#f44336;--group-a:#FFD700;--group-b:#C0C0C0;--group-c:#CD7F32;--group-d:#8B4513}
        body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(135deg,#1e1e1e 0%,#2d2d2d 100%);color:#fff;min-height:100vh;padding:20px}
        .container{max-width:1200px;margin:0 auto}
        h1{text-align:center;font-size:2.2em;margin-bottom:10px;background:linear-gradient(45deg,var(--primary),#ff6666);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:2px 2px 4px rgba(0,0,0,.25)}
        .subtitle{text-align:center;font-size:1.05em;color:#aaa;margin-bottom:20px}
        .tabs{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;justify-content:center}
        .tab{padding:10px 18px;background:var(--secondary);border:none;color:white;cursor:pointer;border-radius:30px;font-size:1em;transition:all .2s}
        .tab.active{background:var(--primary);box-shadow:0 5px 20px rgba(255,51,51,.25)}
        .tab-content{display:none}
        .tab-content.active{display:block}
        .card{background:rgba(255,255,255,.04);border-radius:12px;padding:18px;margin-bottom:18px;backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.06)}
        .input-group{display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap}
        input,select,button{font:inherit}
        input,select{flex:1;padding:10px;border:2px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:white;border-radius:8px;min-width:160px}
        button{padding:10px 18px;background:var(--primary);color:white;border:none;border-radius:8px;cursor:pointer}
        button:disabled{background:#666;cursor:not-allowed}
        .drivers-list{display:grid;gap:10px;margin-top:10px}
        .driver-item{display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(255,255,255,.03);border-radius:8px}
        .time-input{width:110px}
        .group-badge{padding:5px 12px;border-radius:20px;font-weight:700;text-transform:uppercase;font-size:.85em;display:inline-block;margin-left:10px}
        .group-A{background:var(--group-a);color:black}.group-B{background:var(--group-b);color:black}.group-C{background:var(--group-c);color:white}.group-D{background:var(--group-d);color:white}
        .bonus-card{padding:14px;margin:10px 0;border-radius:12px;text-align:center;font-weight:700}
        .podium{display:flex;justify-content:center;gap:14px;margin:18px 0;flex-wrap:wrap}
        .podium-item{padding:12px;border-radius:12px;background:rgba(255,255,255,.03);min-width:140px;text-align:center}
        .podium-1{background:linear-gradient(135deg,var(--group-a),#ffcc00);transform:scale(1.05)}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:10px}
        .stat-card{background:linear-gradient(135deg,rgba(255,255,255,.06),rgba(255,255,255,.03));padding:14px;border-radius:12px;text-align:center}
        .stat-value{font-size:1.6em;color:var(--primary);font-weight:700}
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:1000;align-items:center;justify-content:center}
        .modal-content{background:rgba(255,255,255,.06);padding:18px;border-radius:12px;max-width:520px;width:92%;text-align:center}
        .card-spinning{animation:spin 900ms linear}
        .podium{display:flex;justify-content:center;gap:14px;margin:18px 0;flex-wrap:wrap}
        .podium-item{padding:12px;border-radius:12px;background:rgba(255,255,255,.03);min-width:140px;text-align:center}
        .podium-1{background:linear-gradient(135deg,gold,#ffcc00);transform:scale(1.05)}
        .podium-2{background:linear-gradient(135deg,silver,#ddd)}
        .podium-3{background:linear-gradient(135deg,#cd7f32,#b87333)}
        @keyframes spin{0%{transform:rotateY(0)}50%{transform:rotateY(180deg)}100%{transform:rotateY(360deg)}}
        @media (max-width:768px){h1{font-size:1.6em}.podium{flex-direction:column;align-items:center}.podium-item{width:100%;max-width:320px}}
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÅ Turniej Wy≈õcigowy</h1>
        <p class="subtitle">Manager turnieju gotowy na GitHub Pages ‚Äî kwalifikacje ‚Üí grupy ‚Üí puchar</p>

        <div class="tabs">
            <button class="tab active" data-tab="setup" onclick="showTab('setup', this)">üìù Uczestnicy</button>
            <button class="tab" data-tab="qualifying" onclick="showTab('qualifying', this)">‚è±Ô∏è Kwalifikacje</button>
            <button class="tab" data-tab="groups" onclick="showTab('groups', this)">üéØ Eliminacje</button>
            <button class="tab" data-tab="knockout" onclick="showTab('knockout', this)">üèÜ Faza Pucharowa</button>
            <button class="tab" data-tab="stats" onclick="showTab('stats', this)">üìä Statystyki</button>
        </div>

        <!-- Setup -->
        <div id="setup" class="tab-content active">
            <div class="card">
                <h2>Dodaj uczestnik√≥w</h2>
                <div class="input-group">
                    <input id="driverName" type="text" placeholder="Imiƒô kierowcy" onkeypress="if(event.key==='Enter') addDriver()" />
                    <button onclick="addDriver()">Dodaj kierowcƒô</button>
                </div>
                <div id="driversList" class="drivers-list"></div>
                <button onclick="startQualifying()" style="margin-top:16px;width:100%">Rozpocznij kwalifikacje ‚Üí</button>
            </div>
        </div>

        <!-- Qualifying -->
        <div id="qualifying" class="tab-content">
            <div class="card">
                <h2>Kwalifikacje - Pomiar czas√≥w</h2>
                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px">
                    <button onclick="randomizeOrder()">üé≤ Losuj kolejno≈õƒá</button>
                    <button onclick="finishQualifying()">Zako≈Ñcz kwalifikacje i podziel na grupy ‚Üí</button>
                </div>
                <div id="qualifyingList"></div>
            </div>
        </div>

        <!-- Groups -->
        <div id="groups" class="tab-content">
            <div class="card">
                <h2>Eliminacje grupowe</h2>
                <div style="display:flex;gap:8px;justify-content:center;margin-bottom:12px">
                    <button class="group-stage-tab active" onclick="showGroupStage('times', this)">Czasy przejazd√≥w</button>
                    <button class="group-stage-tab" id="bonusTabButton" onclick="showGroupStage('bonuses', this)" disabled>Karty bonusowe</button>
                    <button class="group-stage-tab" onclick="showGroupStage('podium', this)">Podium grup</button>
                </div>
                <div id="groupTimesDisplay" class="group-stage-content"></div>
                <div id="groupBonusesDisplay" class="group-stage-content" style="display:none"></div>
                <div id="groupPodiumDisplay" class="group-stage-content" style="display:none"></div>
                <button onclick="startKnockout()" style="margin-top:12px;width:100%">Przejd≈∫ do fazy pucharowej ‚Üí</button>
            </div>
        </div>

        <!-- Knockout -->
        <div id="knockout" class="tab-content">
            <div class="card">
                <h2>Faza Pucharowa</h2>
                <div id="tournamentBracket"></div>
            </div>
        </div>

        <!-- Stats -->
        <div id="stats" class="tab-content">
            <div class="card">
                <h2>Statystyki turnieju</h2>
                <div id="tournamentStats" class="stats"></div>
                <div id="finalPodium"></div>
                <div id="finalWinner"></div>
            </div>
        </div>

    </div>

    <div id="bonusCardModal" class="modal">
        <div class="modal-content">
            <h2 id="bonusCardTitle">Karta Bonusowa</h2>
            <div id="bonusCardIcon" style="font-size:3.6em;margin:14px 0"></div>
            <p id="bonusCardDescription"></p>
            <div id="bonusCardStats" style="margin:12px 0;padding:10px;background:rgba(0,0,0,.18);border-radius:8px"></div>
            <div style="display:flex;gap:10px;justify-content:center;margin-top:10px">
                <button onclick="closeBonusCardModal()">Zamknij</button>
            </div>
        </div>
    </div>

    <script>
        // Aplikacja - prosty, serializowalny stan
        let appState = {
            drivers: [],
            stage: 'setup',
            groups: { A: [], B: [], C: [], D: [] },
            knockoutBracket: [],
            finalStandings: [],
            bonusCards: [
                { name: 'Turbo', effect: -1.5, target: 'worse', type: 'positive', icon: 'üöÄ', description: 'Odejmij 1.5s od gorszego przejazdu' },
                { name: 'Nitro', effect: -2, target: 'worse', type: 'positive', icon: 'üí®', description: 'Odejmij 2s od gorszego przejazdu' },
                { name: 'Czysta linia', effect: 'repeat', type: 'positive', icon: 'üéØ', description: 'Powt√≥rz przejazd i wybierz lepszy wynik' },
                { name: 'Lepsze opony', effect: 0.98, target: 'better_multiply', type: 'positive', icon: 'üõû', description: 'Czas lepszego przejazdu x0.98' },
                { name: 'Lepsze paliwo', effect: -1, target: 'worse', type: 'positive', icon: '‚õΩ', description: 'Odejmij 1s od gorszego przejazdu' },
                { name: 'Perfekcyjny start', effect: -2.137, target: 'worse', type: 'positive', icon: 'üèÅ', description: 'Odejmij 2.137s od gorszego przejazdu' },
                { name: 'Z≈Çapa≈Çe≈õ kapcia', effect: 2, target: 'better', type: 'negative', icon: 'üëü', description: 'Dodaj 2s do lepszego przejazdu' },
                { name: '≈öliska nawierzchnia', effect: 1.5, target: 'better', type: 'negative', icon: 'üåßÔ∏è', description: 'Dodaj 1.5s do lepszego przejazdu' },
                { name: 'Pechowy zakrƒôt', effect: 2.5, target: 'worse', type: 'negative', icon: 'üîÑ', description: 'Dodaj 2.5s do gorszego przejazdu' },
                { name: 'Zmƒôczenie', effect: 1.69, target: 'better', type: 'negative', icon: 'üò¥', description: 'Dodaj 1.69s do lepszego przejazdu' },
                { name: 'Pechowy driver', effect: 'worst', type: 'negative', icon: 'üíÄ', description: 'Lepszy czas zostaje zamieniony na warto≈õƒá najgorszego czasu w tabeli' },
                { name: 'Pit stop', effect: 1.02, target: 'worse_multiply', type: 'negative', icon: 'üîß', description: 'Czas gorszego przejazdu x1.02' }
            ],
            groupStage: 'times'
        };

        // Load / Save
        function loadState(){
            try{
                const raw = localStorage.getItem('racingTournament');
                if(!raw) return;
                const parsed = JSON.parse(raw);
                // Basic compatibility/fallbacks
                appState = Object.assign(appState, parsed);
                // ensure arrays exist
                appState.groups = appState.groups || {A:[],B:[],C:[],D:[]};
                updateAllDisplays();
            }catch(e){console.warn('Failed to load state', e)}
        }
        function saveState(){
            localStorage.setItem('racingTournament', JSON.stringify(appState));
            // subtle visual feedback
            const n = document.getElementById('saveNotification');
            if(n){n.style.display='block';setTimeout(()=>n.style.display='none',1200)}
        }

        // Helpers
        function findDriverById(id){return appState.drivers.find(d=>d.id===id)}

        // UI: Tabs
        function showTab(tabName, btn){
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
            if(btn) btn.classList.add('active');
            const el = document.getElementById(tabName);
            if(el) el.classList.add('active');
            updateAllDisplays();
        }

        // Group stage tab
        function showGroupStage(stage, btn){
            appState.groupStage = stage;
            document.querySelectorAll('.group-stage-tab').forEach(t=>t.classList.remove('active'));
            if(btn) btn.classList.add('active');
            document.querySelectorAll('.group-stage-content').forEach(c=>c.style.display='none');
            if(stage==='times') document.getElementById('groupTimesDisplay').style.display='block';
            if(stage==='bonuses') { document.getElementById('groupBonusesDisplay').style.display='block'; updateBonusesDisplay(); }
            if(stage==='podium') { document.getElementById('groupPodiumDisplay').style.display='block'; updatePodiumDisplay(); }
            saveState();
        }

        // Drivers management
        function addDriver(){
            const input = document.getElementById('driverName');
            const name = input.value.trim();
            if(!name) return;
            if(appState.drivers.some(d=>d.name===name)){
                alert('Kierowca o takiej nazwie ju≈º istnieje');
                return;
            }
            const driver = { id: Date.now()+Math.floor(Math.random()*1000), name, qualifyingTime1:null, qualifyingTime2:null, avgTime:null, group:null, groupTime1:null, groupTime2:null, repeatedTime:null, bonusCard:null, finalGroupTime:null, originalAvgTime:null };
            appState.drivers.push(driver);
            input.value='';
            updateDriversList();
            saveState();
        }
        function removeDriver(id){
            if(!confirm('Usu≈Ñ kierowcƒô?')) return;
            appState.drivers = appState.drivers.filter(d=>d.id!==id);
            updateDriversList();
            saveState();
        }
        function updateDriversList(){
            const list = document.getElementById('driversList');
            list.innerHTML = appState.drivers.map(d=>`<div class="driver-item"><span>${escapeHtml(d.name)}</span><div><button onclick="removeDriver(${d.id})" style="background:var(--danger)">Usu≈Ñ</button></div></div>`).join('') || '<div class="card">Brak zawodnik√≥w ‚Äî dodaj minimum 4</div>';
        }

        // Qualifying
        function randomizeOrder(){
            appState.drivers = shuffleArray(appState.drivers);
            updateQualifyingList();
            saveState();
        }
        function updateQualifyingList(){
            const list = document.getElementById('qualifyingList');
            if(!appState.drivers.length) { list.innerHTML='<div class="card">Brak zawodnik√≥w</div>'; return }
            list.innerHTML = appState.drivers.map((driver, idx)=>{
                return `<div class="driver-item"><span>${idx+1}. ${escapeHtml(driver.name)}</span><div style="display:flex;gap:8px;align-items:center"><input type="number" class="time-input" placeholder="Czas 1" step="0.01" min="0" value="${driver.qualifyingTime1==null?'':driver.qualifyingTime1}" onchange="updateQualifyingTime(${driver.id},1,this.value)"><input type="number" class="time-input" placeholder="Czas 2" step="0.01" min="0" value="${driver.qualifyingTime2==null?'':driver.qualifyingTime2}" onchange="updateQualifyingTime(${driver.id},2,this.value)"><span style="min-width:110px;text-align:right">${driver.avgTime?`≈örednia: ${driver.avgTime.toFixed(2)}s`:''}</span></div></div>`
            }).join('');
        }
        function updateQualifyingTime(id, run, value){
            const driver = findDriverById(id); if(!driver) return;
            const v = parseFloat(value); if(isNaN(v)||v<0) return;
            if(run===1) driver.qualifyingTime1 = v; if(run===2) driver.qualifyingTime2 = v;
            if(driver.qualifyingTime1!=null && driver.qualifyingTime2!=null) driver.avgTime = (driver.qualifyingTime1+driver.qualifyingTime2)/2;
            updateQualifyingList(); saveState();
        }
        function startQualifying(){
            if(appState.drivers.length<4){ alert('Potrzebujesz minimum 4 kierowc√≥w!'); return }
            appState.stage='qualifying'; showTab('qualifying', document.querySelector('[data-tab="qualifying"]'));
            updateQualifyingList();
        }

        // Finish qualifying and split groups
        function finishQualifying(){
            if(appState.drivers.some(d=>d.avgTime==null)){ alert('Nie wszyscy majƒÖ wpisane czasy kwalifikacji'); return }
            const sorted = [...appState.drivers].sort((a,b)=>a.avgTime-b.avgTime);
            const total = sorted.length; const groupSize = Math.ceil(total/4);
            appState.groups.A = sorted.slice(0,groupSize).map(cloneDriverForGroup);
            appState.groups.B = sorted.slice(groupSize,groupSize*2).map(cloneDriverForGroup);
            appState.groups.C = sorted.slice(groupSize*2,groupSize*3).map(cloneDriverForGroup);
            appState.groups.D = sorted.slice(groupSize*3).map(cloneDriverForGroup);
            ['A','B','C','D'].forEach(g=>{ appState.groups[g].forEach(d=>{ d.group=g; const main = appState.drivers.find(x=>x.id===d.id); if(main){ main.group=g } }) });
            appState.stage='groups'; showTab('groups', document.querySelector('[data-tab="groups"]'));
            updateGroupsDisplay(); saveState();
        }
        function cloneDriverForGroup(d){
            // we will reference main driver object by id ‚Äî keep minimal copy
            return { id: d.id, name: d.name, avgTime: d.avgTime, groupTime1:null, groupTime2:null, repeatedTime:null, bonusCard:null, finalGroupTime:null, originalAvgTime:null };
        }

        // Groups display
        function updateGroupsDisplay(){
            const display = document.getElementById('groupTimesDisplay');
            display.innerHTML = ['A','B','C','D'].map(group=>{
                const groupName = {A:'Zapierdalacze',B:'≈öredni (Super)',C:'Niedzielni',D:'Za≈õlimaczeni'}[group];
                const list = (appState.groups[group]||[]).map(driver=>{
                    // sync group times from main driver if present
                    const main = appState.drivers.find(d=>d.id===driver.id);
                    if(main){ driver.groupTime1 = driver.groupTime1 ?? main.groupTime1 ?? null; driver.groupTime2 = driver.groupTime2 ?? main.groupTime2 ?? null }
                    return `<div class="driver-item" style="margin:8px 0"><span>${escapeHtml(driver.name)} (≈ör. kwal: ${driver.avgTime?driver.avgTime.toFixed(2):'‚Äî'}s)</span><div style="display:flex;gap:8px;align-items:center"><input type="number" class="time-input" placeholder="Czas 1" step="0.01" min="0" value="${driver.groupTime1==null?'':driver.groupTime1}" onchange="updateGroupTime(${driver.id},1,this.value)"><input type="number" class="time-input" placeholder="Czas 2" step="0.01" min="0" value="${driver.groupTime2==null?'':driver.groupTime2}" onchange="updateGroupTime(${driver.id},2,this.value)"></div></div>`
                }).join('') || '<div class="card">Brak zawodnik√≥w w tej grupie</div>';
                return `<div class="card"><h3>Grupa ${group} - ${groupName} <span class="group-badge group-${group}">${group}</span></h3>${list}</div>`
            }).join('');
            // enable bonuses tab only when all group times for drivers in groups are filled
            const allInGroups = ['A','B','C','D'].flatMap(g=>appState.groups[g]||[]);
            const allTimesEntered = allInGroups.length>0 && allInGroups.every(d=>d.groupTime1!=null && d.groupTime2!=null);
            const bonusBtn = document.getElementById('bonusTabButton'); if(bonusBtn) bonusBtn.disabled = !allTimesEntered;
        }

        // Update group time (stores both on main driver and group copy)
        function updateGroupTime(id, run, value){
            const v = parseFloat(value); if(isNaN(v)||v<0) return;
            // update main driver
            const main = appState.drivers.find(d=>d.id===id);
            if(!main) return;
            if(run===1) main.groupTime1 = v; if(run===2) main.groupTime2 = v;
            if(main.groupTime1!=null && main.groupTime2!=null && !main.originalAvgTime) main.originalAvgTime = (main.groupTime1+main.groupTime2)/2;
            // update group copy
            ['A','B','C','D'].forEach(g=>{ const copy = (appState.groups[g]||[]).find(x=>x.id===id); if(copy){ if(run===1) copy.groupTime1 = v; if(run===2) copy.groupTime2 = v } });
            updateGroupsDisplay(); saveState();
        }

        // Bonuses display and logic
        function updateBonusesDisplay(){
            const display = document.getElementById('groupBonusesDisplay');
            display.innerHTML = ['A','B','C','D'].map(group=>{
                const groupName = {A:'Zapierdalacze',B:'≈öredni (Super)',C:'Niedzielni',D:'Za≈õlimaczeni'}[group];
                const list = (appState.groups[group]||[]).map(driver=>{
                    const main = appState.drivers.find(d=>d.id===driver.id);
                    const gt1 = main?.groupTime1 ?? driver.groupTime1; const gt2 = main?.groupTime2 ?? driver.groupTime2;
                    const avg = (gt1!=null && gt2!=null) ? ((gt1+gt2)/2).toFixed(2) : '‚Äî';
                    const btnLabel = main?.bonusCard ? `${escapeHtml(main.bonusCard.name)}` : 'üé∞ Losuj kartƒô';
                    return `<div class="driver-item" style="margin:8px 0"><div><div>${escapeHtml(driver.name)}</div><div style="font-size:.85em;color:#aaa;margin-top:6px">Czasy: ${gt1!=null?gt1.toFixed(2)+'s':'‚Äî'}, ${gt2!=null?gt2.toFixed(2)+'s':'‚Äî'} | ≈örednia: ${avg}</div></div><div style="display:flex;gap:8px;align-items:center"><button onclick="drawBonusCard(${driver.id})" ${main && main.bonusCard? 'disabled':''}>${btnLabel}</button></div>${main && main.bonusCard?`<div style="margin-top:8px;padding:8px;background:rgba(0,0,0,.15);border-radius:8px"><div>Bonus: ${escapeHtml(main.bonusCard.name)}</div><div>Nowy czas: <strong>${main.finalGroupTime!=null?main.finalGroupTime.toFixed(2)+'s':'‚Äî'}</strong></div></div>`:''}${main && main.bonusCard && main.bonusCard.effect==='repeat' && main.repeatedTime==null?`<div class="repeat-time-input" style="margin-top:8px"><span style="margin-right:8px">Czas powt√≥rzonego przejazdu:</span><input type="number" class="time-input" step="0.01" min="0" placeholder="Czas powt√≥rzenia" onchange="updateRepeatedTime(${driver.id},this.value)"></div>`:''}</div>`
                }).join('') || '<div class="card">Brak zawodnik√≥w w tej grupie</div>';
                return `<div class="card"><h3>Grupa ${group} - ${groupName} <span class="group-badge group-${group}">${group}</span></h3>${list}</div>`
            }).join('');
        }

        function updateRepeatedTime(id, value){
            const v = parseFloat(value); if(isNaN(v)||v<0) return; const main = findDriverById(id); if(!main) return; main.repeatedTime = v; calculateFinalGroupTime(main); updateBonusesDisplay(); saveState();
        }

        function drawBonusCard(id){
            const main = findDriverById(id); if(!main) return; if(main.groupTime1==null || main.groupTime2==null){ alert('Najpierw wpisz oba czasy!'); return }
            const card = appState.bonusCards[Math.floor(Math.random()*appState.bonusCards.length)];
            main.bonusCard = card;
            if(!main.originalAvgTime) main.originalAvgTime = (main.groupTime1+main.groupTime2)/2;
            calculateFinalGroupTime(main);
            showBonusCardAnimation(card, main);
            updateBonusesDisplay(); saveState();
        }

        function showBonusCardAnimation(card, driver){
            const modal = document.getElementById('bonusCardModal');
            document.getElementById('bonusCardTitle').textContent = card.name + ' ' + (card.icon||'');
            const iconEl = document.getElementById('bonusCardIcon'); iconEl.textContent = card.icon || '';
            iconEl.classList.add('card-spinning');
            document.getElementById('bonusCardDescription').textContent = `${driver.name} wylosowa≈Ç: ${card.description}`;
            const originalAvg = driver.originalAvgTime ?? ((driver.groupTime1+driver.groupTime2)/2);
            const newAvg = driver.finalGroupTime ?? originalAvg;
            const diff = (newAvg - originalAvg).toFixed(2);
            document.getElementById('bonusCardStats').innerHTML = `<div>≈örednia przed bonusem: <strong>${originalAvg.toFixed(2)}s</strong></div><div>≈örednia po bonusie: <strong>${newAvg.toFixed(2)}s</strong></div><div>R√≥≈ºnica: <strong style="color:${newAvg<originalAvg? '#4CAF50':'#f44336'}">${diff}s</strong></div>`;
            modal.style.display='flex'; setTimeout(()=>iconEl.classList.remove('card-spinning'),900);
        }
        function closeBonusCardModal(){ document.getElementById('bonusCardModal').style.display='none' }

        // Calculate final group time based on card
        function calculateFinalGroupTime(driver){
            if(driver.groupTime1==null || driver.groupTime2==null) return;
            let t1 = driver.groupTime1, t2 = driver.groupTime2;
            let better = Math.min(t1,t2), worse = Math.max(t1,t2);
            if(driver.bonusCard){ const card = driver.bonusCard; switch(card.effect){
                case 'repeat':
                    if(driver.repeatedTime!=null){ better = Math.min(better, driver.repeatedTime); worse = Math.max(better, driver.repeatedTime); }
                    // final is average of better + worse
                    driver.finalGroupTime = (better + worse)/2; break;
                case 'worst':
                    // set better to current worst time across all drivers
                    const allWorst = appState.drivers.filter(d=>d.groupTime1!=null && d.groupTime2!=null).map(d=>Math.max(d.groupTime1,d.groupTime2));
                    if(allWorst.length) better = Math.max(...allWorst);
                    driver.finalGroupTime = (better + worse)/2; break;
                default:
                    if(card.target === 'worse') worse += card.effect;
                    else if(card.target === 'better') better += card.effect;
                    else if(card.target === 'better_multiply') better *= card.effect;
                    else if(card.target === 'worse_multiply') worse *= card.effect;
                    driver.finalGroupTime = (better + worse)/2; break;
            }} else { driver.finalGroupTime = (t1 + t2)/2 }
        }

        // Knockout: build bracket using group rankings
        function startKnockout(){
            // Ensure all drivers in groups have finalGroupTime
            const allAssigned = ['A','B','C','D'].flatMap(g=>appState.groups[g]||[]);
            if(allAssigned.length===0){ alert('Brak zawodnik√≥w w grupach'); return }
            const anyMissing = allAssigned.some(d=>{
                const main = findDriverById(d.id); return !main || main.finalGroupTime==null;
            });
            if(anyMissing){ alert('Wszyscy zawodnicy muszƒÖ mieƒá wylosowanƒÖ kartƒô i obliczony czas'); return }
            // Sort groups
            ['A','B','C','D'].forEach(g=>{
                appState.groups[g].sort((x,y)=>{
                    const ax = (findDriverById(x.id)?.finalGroupTime) ?? ((x.groupTime1+x.groupTime2)/2);
                    const by = (findDriverById(y.id)?.finalGroupTime) ?? ((y.groupTime1+y.groupTime2)/2);
                    return ax - by;
                });
            });
            // Build first 1vs1 round as requested
            const make = (a,b,name)=>({name,drivers:[a,b]});
            const matches = [];
            if(appState.groups.A[0] && appState.groups.B[0]) matches.push(make(appState.groups.A[0],appState.groups.B[0],'1 miejsce A vs B'));
            if(appState.groups.C[0] && appState.groups.D[0]) matches.push(make(appState.groups.C[0],appState.groups.D[0],'1 miejsce C vs D'));
            if(appState.groups.A[1] && appState.groups.B[1]) matches.push(make(appState.groups.A[1],appState.groups.B[1],'2 miejsce A vs B'));
            if(appState.groups.C[1] && appState.groups.D[1]) matches.push(make(appState.groups.C[1],appState.groups.D[1],'2 miejsce C vs D'));
            if(appState.groups.A[2] && appState.groups.B[2]) matches.push(make(appState.groups.A[2],appState.groups.B[2],'3 miejsce A vs B'));
            if(appState.groups.C[2] && appState.groups.D[2]) matches.push(make(appState.groups.C[2],appState.groups.D[2],'3 miejsce C vs D'));
            appState.knockoutBracket = [{round:'1vs1', matches: matches.map(m=>({ ...m, winner:null }))}];
            appState.knockoutBracket[0].matches.forEach(m=>{
                m.drivers = m.drivers.filter(Boolean);
                if(m.drivers.length === 1){
                    m.winner = m.drivers[0].id;
                }
            });
            showTab('knockout', document.querySelector('[data-tab=\"knockout\"]'));
            updateKnockoutBracket(); 
            saveState();
        }

        function updateKnockoutBracket(){
            const el = document.getElementById('tournamentBracket');
            if(!appState.knockoutBracket || !appState.knockoutBracket.length){ el.innerHTML='<div class="card">Brak drabinki</div>'; return }
            el.innerHTML = appState.knockoutBracket.map((round,ri)=>{
                const matchesHtml = (round.matches||[]).map((m,mi)=>{
                    const driversHtml = (m.drivers||[]).map(driver=>{
                        if(!driver) return '<div class="match-driver">TBD</div>';
                        const main = findDriverById(driver.id) || driver;
                        const val = main.matchTimes?.[round.round] ?? '';
                        return `<div class="match-driver ${m.winner===main.id? 'winner':''}" style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(0,0,0,.12)"><span>${escapeHtml(main.name)}</span><div><input type="number" class="time-input" placeholder="Czas wy≈õcigu" step="0.01" min="0" value="${val}" onchange="updateMatchTime(${ri},${mi},${main.id},'${round.round}',this.value)">${m.winner===main.id? ' üèÜ':''}</div></div>`
                    }).join('');
                    return `<div class="match"><div class="match-header" style="font-weight:700;color:var(--primary);margin-bottom:8px">${escapeHtml(m.name)}</div><div class="match-drivers" style="display:grid;gap:8px">${driversHtml}</div></div>`
                }).join('');
                let btns = '';
                if(round.round==='1vs1' && round.matches.filter(m=>m.drivers.length>=1).every(m=>m.winner)) btns = `<button onclick="generateQuarterFinals()" style="margin-top:12px;width:100%">Przejd≈∫ dalej ‚Üí</button>`;
                if(round.round==='ƒÜwierƒáfina≈Çy' && round.matches.filter(m=>m.drivers.length>=1).every(m=>m.winner)) btns = `<button onclick="generateSemiFinals()" style="margin-top:12px;width:100%">Przejd≈∫ dalej ‚Üí</button>`;
                if(round.round==='P√≥≈Çfina≈Çy' && round.matches.filter(m=>m.drivers.length>=1).every(m=>m.winner)) btns = `<button onclick="generateFinal()" style="margin-top:12px;width:100%">Przejd≈∫ dalej ‚Üí</button>`;
                if(round.round==='FINA≈Å' && round.matches.filter(m=>m.drivers.length>=1).every(m=>m.winner)) btns = `<button onclick="finishTournament()" style="margin-top:12px;width:100%">Zako≈Ñcz turniej ‚Üí</button>`;
                return `<div class="card"><h3>${escapeHtml(round.round)}</h3><div class="bracket">${matchesHtml}</div>${btns}</div>`
            }).join('');
        }

        function updateMatchTime(roundIdx, matchIdx, driverId, roundName, value){
            const r = appState.knockoutBracket[roundIdx]; if(!r) return;
            const m = r.matches[matchIdx]; if(!m) return;
            const driver = m.drivers.find(d=>d.id===driverId); if(!driver) return;
            const main = findDriverById(driverId) || driver;
            const v = parseFloat(value); if(isNaN(v)||v<0) return;
            if(!main.matchTimes) main.matchTimes = {};
            main.matchTimes[roundName] = v;
            if(!driver.matchTimes) driver.matchTimes = {};
            driver.matchTimes[roundName] = v;
            if(m.drivers.every(d=>d.matchTimes && d.matchTimes[roundName]!=null)){
                const winner = m.drivers.reduce((a,b)=> a.matchTimes[roundName] < b.matchTimes[roundName] ? a : b);
                m.winner = winner.id;
            }
            updateKnockoutBracket();
            saveState();
        }


        function generateQuarterFinals(){
            const last = appState.knockoutBracket.at(-1);
            const winners = last.matches.filter(m=>m.winner).map(m=> m.drivers.find(d=>d.id===m.winner));
            if(winners.length < 2){ alert('Najpierw zako≈Ñcz mecze 1vs1!'); return }
            if(winners.length === 2){
                appState.knockoutBracket.push({
                    round: 'FINA≈Å',
                    matches: [{name:'Fina≈Ç', drivers:[winners[0], winners[1]], winner:null}]
                });
            } else {
                const matches = [];
                for(let i=0;i<winners.length;i+=2){
                    if(winners[i+1]) matches.push({name:`ƒÜwierƒáfina≈Ç ${matches.length+1}`, drivers:[winners[i], winners[i+1]], winner:null});
                    else matches.push({name:`ƒÜwierƒáfina≈Ç ${matches.length+1}`, drivers:[winners[i]], winner:winners[i].id});
                }
                appState.knockoutBracket.push({ round:'ƒÜwierƒáfina≈Çy', matches });
            }
            updateKnockoutBracket(); saveState();
        }
        function generateSemiFinals(){
            const last = appState.knockoutBracket.at(-1);
            const winners = last.matches.filter(m=>m.winner).map(m=> m.drivers.find(d=>d.id===m.winner));
            if(winners.length < 2){ alert('Najpierw zako≈Ñcz ƒáwierƒáfina≈Çy!'); return }
            if(winners.length === 2){
                appState.knockoutBracket.push({
                    round: 'FINA≈Å',
                    matches: [{name:'Fina≈Ç', drivers:[winners[0], winners[1]], winner:null}]
                });
            } else {
                const matches = [];
                for(let i=0;i<winners.length;i+=2){
                    if(winners[i+1]) matches.push({name:`P√≥≈Çfina≈Ç ${matches.length+1}`, drivers:[winners[i], winners[i+1]], winner:null});
                    else matches.push({name:`P√≥≈Çfina≈Ç ${matches.length+1}`, drivers:[winners[i]], winner:winners[i].id});
                }
                appState.knockoutBracket.push({ round:'P√≥≈Çfina≈Çy', matches });
            }
            updateKnockoutBracket(); saveState();
        }
        function generateFinal(){
            const last = appState.knockoutBracket.at(-1);
            const winners = last.matches.filter(m=>m.winner).map(m=> m.drivers.find(d=>d.id===m.winner));
            if(winners.length < 1){ alert('Najpierw zako≈Ñcz p√≥≈Çfina≈Çy!'); return }
            if(winners.length === 1){
                appState.knockoutBracket.push({ round:'FINA≈Å', matches:[{name:'Fina≈Ç', drivers:[winners[0]], winner:winners[0].id}] });
            } else {
                appState.knockoutBracket.push({ round:'FINA≈Å', matches:[{name:'Fina≈Ç', drivers:[winners[0], winners[1]], winner:null}] });
            }
            updateKnockoutBracket(); saveState();
        }

        function finishTournament(){
            const finalRound = appState.knockoutBracket.at(-1);
            const finalMatch = finalRound.matches[0];
            if(!finalMatch.winner){ alert('Najpierw zako≈Ñcz fina≈Ç!'); return; }

            const winner = finalMatch.drivers.find(d=>d.id===finalMatch.winner);
            const loser = finalMatch.drivers.find(d=>d.id!==finalMatch.winner);

            // znajd≈∫ przegranych z p√≥≈Çfina≈Ç√≥w do 3 miejsca
            const semifinalRound = appState.knockoutBracket.find(r=>r.round==='P√≥≈Çfina≈Çy');
            let thirds = [];
            if(semifinalRound){
                const losers = semifinalRound.matches.map(m=>{
                    if(!m.winner) return null;
                    return m.drivers.find(d=>d.id!==m.winner);
                }).filter(Boolean);
                thirds = losers;
            } else {
                // je≈õli nie ma p√≥≈Çfina≈Ç√≥w (np. tylko 4 uczestnik√≥w),
                // to 3 miejsce dla przegranych z poprzedniej rundy
                const prevRound = appState.knockoutBracket.at(-2);
                if(prevRound){
                    const losers = prevRound.matches.map(m=>{
                        if(!m.winner) return null;
                        return m.drivers.find(d=>d.id!==m.winner);
                    }).filter(Boolean);
                    thirds = losers;
                }
            }

            // zapisz do stanu
            appState.finalStandings = [];
            if(winner) appState.finalStandings.push({position:1, driver:winner});
            if(loser) appState.finalStandings.push({position:2, driver:loser});
            thirds.forEach(d => appState.finalStandings.push({position:3, driver:d}));

            saveState();
            updateStats();
            showTab('stats', document.querySelector('[data-tab=\"stats\"]'));
        }

        function updateStats(){
            const stats = document.getElementById('tournamentStats');
            const allTimes = appState.drivers.filter(d=>d.avgTime!=null).map(d=>d.avgTime);
            if(allTimes.length===0){ stats.innerHTML = '<div class="card">Brak danych kwalifikacji</div>'; return }
            const fastest = Math.min(...allTimes); const slowest = Math.max(...allTimes); const avg = allTimes.reduce((a,b)=>a+b,0)/allTimes.length;
            stats.innerHTML = `<div class="stat-card"><div class="stat-label">Liczba kierowc√≥w</div><div class="stat-value">${appState.drivers.length}</div></div><div class="stat-card"><div class="stat-label">Najszybszy czas kwalifikacji</div><div class="stat-value">${fastest.toFixed(2)}s</div></div><div class="stat-card"><div class="stat-label">Najwolniejszy czas kwalifikacji</div><div class="stat-value">${slowest.toFixed(2)}s</div></div><div class="stat-card"><div class="stat-label">≈öredni czas kwalifikacji</div><div class="stat-value">${avg.toFixed(2)}s</div></div>`;
            // Final podium
            const fp = document.getElementById('finalPodium'); const fw = document.getElementById('finalWinner');
            if(appState.finalStandings && appState.finalStandings.length){
                const podiumByPos = {1:[],2:[],3:[]};
                appState.finalStandings.forEach(s=> podiumByPos[s.position].push(s.driver));

                fp.innerHTML = `<div class="card"><h2 style="text-align:center">üèÜ KO≈ÉCOWE PODIUM üèÜ</h2>
                <div class="podium">
                ${podiumByPos[1].map(d=>`<div class="podium-item podium-1"><div style="font-size:1.6em">ü•á</div><div style="font-weight:700;font-size:1.05em">${escapeHtml(d.name)}</div><div>Grupa ${escapeHtml(d.group||'‚Äî')}</div></div>`).join('')}
                ${podiumByPos[2].map(d=>`<div class="podium-item podium-2"><div style="font-size:1.6em">ü•à</div><div style="font-weight:700;font-size:1.05em">${escapeHtml(d.name)}</div><div>Grupa ${escapeHtml(d.group||'‚Äî')}</div></div>`).join('')}
                ${podiumByPos[3].map(d=>`<div class="podium-item podium-3"><div style="font-size:1.6em">ü•â</div><div style="font-weight:700;font-size:1.05em">${escapeHtml(d.name)}</div><div>Grupa ${escapeHtml(d.group||'‚Äî')}</div></div>`).join('')}
                </div></div>`;
                const champ = appState.finalStandings[0].driver; fw.innerHTML = `<div class="card" style="text-align:center;background:linear-gradient(135deg,var(--group-a),var(--warning));margin-top:10px"><div style="font-size:2.2em">üèÜ</div><h2 style="margin:8px 0">ZWYCIƒòZCA TURNIEJU</h2><h3 style="font-size:1.6em">${escapeHtml(champ.name)}</h3><p>Grupa ${escapeHtml(champ.group||'‚Äî')}</p></div>`;
            } else { fp.innerHTML=''; fw.innerHTML=''; }
        }

        // Utility functions
        function shuffleArray(a){ return a.sort(()=>Math.random()-0.5) }
        function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]) }

        // updateAll
        function updateAllDisplays(){ updateDriversList(); updateQualifyingList(); if(appState.stage==='groups'){ if(appState.groupStage==='times') updateGroupsDisplay(); if(appState.groupStage==='bonuses') updateBonusesDisplay(); if(appState.groupStage==='podium') updatePodiumDisplay(); } updateKnockoutBracket(); updateStats(); }

        // small podium display used in groups
        function updatePodiumDisplay(){
            const display = document.getElementById('groupPodiumDisplay');
            display.innerHTML = ['A','B','C','D'].map(group=>{
                const groupName = {A:'Zapierdalacze',B:'≈öredni (Super)',C:'Niedzielni',D:'Za≈õlimaczeni'}[group];
                const drivers = (appState.groups[group]||[]).slice();
                drivers.forEach(d=>{ const main = findDriverById(d.id); if(main){ d.final = main.finalGroupTime ?? ((d.groupTime1!=null && d.groupTime2!=null)? (d.groupTime1+d.groupTime2)/2 : null) } });
                drivers.sort((a,b)=> (a.final??9999) - (b.final??9999));
                const podium = drivers.slice(0,3).map((d,i)=>`<div class="podium-item podium-${i+1}"><div style="font-size:1.2em">${i===0?'ü•á':i===1?'ü•à':'ü•â'}</div><div style="font-weight:700">${escapeHtml(d.name)}</div><div>${d.final? d.final.toFixed(2)+'s':'‚Äî'}</div></div>`).join('');
                const rest = drivers.slice(3).map(d=>`<div class="driver-item" style="margin:6px 0"><span>${escapeHtml(d.name)}</span><span>${d.final? d.final.toFixed(2)+'s':'‚Äî'}</span></div>`).join('');
                return `<div class="card"><h3>Grupa ${group} - ${groupName} <span class="group-badge group-${group}">${group}</span></h3><div class="podium">${podium}</div>${rest?`<div style="margin-top:10px"><h4>Pozostali:</h4>${rest}</div>`:''}</div>`
            }).join('');
        }

        // init
        window.addEventListener('load', ()=>{
            loadState();
            // add reset button
            const container = document.querySelector('.container');
            const resetBtn = document.createElement('button'); resetBtn.textContent='üîÑ Reset turnieju'; resetBtn.style.cssText='background:var(--danger);margin-top:12px'; resetBtn.onclick=()=>{ if(confirm('Czy na pewno?')){ localStorage.removeItem('racingTournament'); location.reload() } };
            container.appendChild(resetBtn);
        });
    </script>
</body>
</html>
